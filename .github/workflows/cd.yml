name: CD Deploy to EC2 via SSM

on:
  workflow_run:
    workflows: ["CI Build and Push"]  # name must match CI workflow name EXACTLY
    types:
      - completed

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ap-south-1
  ACCOUNT_ID: 550933156296
  ECR_REPO: demo_ecr_repo
  EC2_INSTANCE_ID: i-03d59ac0ab147679e

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v3
        with:
          role-to-assume: arn:aws:iam::550933156296:role/GitHubActions-Deploy-Role
          aws-region: ${{ env.AWS_REGION }}

      - name: Compute ECR URI and image tag
        id: vars
        run: |
          ECR_URI="${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPO}"
          IMAGE_TAG=${{ github.event.workflow_run.head_sha }}
          IMAGE_TAG=${IMAGE_TAG::8}
          echo "ECR_URI=$ECR_URI" >> $GITHUB_OUTPUT
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_OUTPUT

      - name: Trigger SSM deploy on EC2
        run: |
          aws ssm send-command \
            --region "${AWS_REGION}" \
            --instance-ids "${EC2_INSTANCE_ID}" \
            --document-name "AWS-RunShellScript" \
            --comment "Deploy from GitHub Actions (CI â†’ CD)" \
            --parameters commands="bash /home/ec2-user/deploy_scripts/deploy_docker.sh ${AWS_REGION} ${{ steps.vars.outputs.ECR_URI }} ${{ steps.vars.outputs.IMAGE_TAG }}"